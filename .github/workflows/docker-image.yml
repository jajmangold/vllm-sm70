name: Build vLLM sm70 Image

on:
  schedule:
    # Check daily at 6am UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      vllm_version:
        description: 'vLLM version to build (e.g., v0.12.0)'
        required: false
        default: ''

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.check.outputs.new_release }}
      version: ${{ steps.check.outputs.version }}
      pytorch_version: ${{ steps.check.outputs.pytorch_version }}
    steps:
      - name: Check for new vLLM release and get PyTorch version
        id: check
        run: |
          # Get latest vLLM release
          LATEST=$(curl -s https://api.github.com/repos/vllm-project/vllm/releases/latest | jq -r .tag_name)
          
          # Use manual input if provided
          if [ -n "${{ github.event.inputs.vllm_version }}" ]; then
            LATEST="${{ github.event.inputs.vllm_version }}"
          fi
          
          echo "Latest vLLM version: $LATEST"
          
          # Get PyTorch version from vLLM's pyproject.toml
          PYTORCH_REQ=$(curl -s "https://raw.githubusercontent.com/vllm-project/vllm/${LATEST}/pyproject.toml" | \
            grep -E "torch[>=<]" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          if [ -z "$PYTORCH_REQ" ]; then
            # Fallback: check requirements files
            PYTORCH_REQ=$(curl -s "https://raw.githubusercontent.com/vllm-project/vllm/${LATEST}/requirements-common.txt" | \
              grep -E "^torch" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          fi
          
          # Default to 2.9.0 if we can't determine
          PYTORCH_VERSION=${PYTORCH_REQ:-2.9.0}
          echo "PyTorch version for vLLM $LATEST: $PYTORCH_VERSION"
          
          # Check if we already have this version
          EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/jajmangold/vllm-sm70/manifests/${LATEST}")
          
          if [ "$EXISTS" = "200" ] && [ -z "${{ github.event.inputs.vllm_version }}" ]; then
            echo "Version $LATEST already exists, skipping build"
            echo "new_release=false" >> $GITHUB_OUTPUT
          else
            echo "Building version $LATEST with PyTorch $PYTORCH_VERSION"
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST" >> $GITHUB_OUTPUT
            echo "pytorch_version=$PYTORCH_VERSION" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-release
    if: needs.check-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af --volumes || true
          echo "Disk space after cleanup:"
          df -h
      
      - name: Update Dockerfile with versions
        run: |
          VLLM_VERSION=${{ needs.check-release.outputs.version }}
          PYTORCH_VERSION=${{ needs.check-release.outputs.pytorch_version }}
          
          # Update PyTorch version
          sed -i "s/PYTORCH_BUILD_VERSION=2.9.0+sm70/PYTORCH_BUILD_VERSION=${PYTORCH_VERSION}+sm70/" Dockerfile
          sed -i "s/git fetch --depth 1 origin v2.9.0/git fetch --depth 1 origin v${PYTORCH_VERSION}/" Dockerfile
          sed -i "s/git checkout v2.9.0/git checkout v${PYTORCH_VERSION}/" Dockerfile
          
          # Update vLLM version
          sed -i "s/git fetch --depth 1 origin v0.12.0/git fetch --depth 1 origin ${VLLM_VERSION}/" Dockerfile
          sed -i "s/git checkout v0.12.0/git checkout ${VLLM_VERSION}/" Dockerfile
          
          echo "Building vLLM $VLLM_VERSION with PyTorch $PYTORCH_VERSION"
          cat Dockerfile
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/jajmangold/vllm-sm70:${{ needs.check-release.outputs.version }}
            ghcr.io/jajmangold/vllm-sm70:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          platforms: linux/amd64
